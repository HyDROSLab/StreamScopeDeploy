"""

StreamScope Results

This script reads log files generated by StreamScope and extracts information for plotting.

Currently, the script only generates plots for average distance vs. time for specified angles.

A future version of the script will include cross-sectional area plots.

Usage: Run the script and follow the menu options to generate the desired plots.

Author: Braden White
Last Updated: 02-12-2025

"""

import os
import re
import matplotlib.pyplot as plt
import datetime


def classify_angle(angle, requested_angles, tolerance=1):
    """
    Classifies an angle based on a list of requested angles and a tolerance.

    Parameters:
    angle (float): The angle to classify.
    requested_angles (list of float): A list of angles to compare against.
    tolerance (float, optional): The maximum difference allowed between the angle and any requested angle. Defaults to 1.

    Returns:
    float or None: The requested angle that is within the tolerance of the given angle, or None if no such angle exists.
    """

    for requested_angle in requested_angles:
        if abs(angle - requested_angle) <= tolerance:
            return requested_angle
    return None 

def read_log_file(file_path, requested_angles, tolerance=1):
    """
    Reads a log file and extracts timestamps, sonar distances, and angle data.

    Parameters:
        file_path (str): The path to the log file.
        requested_angles (list of int): A list of requested angles.
        tolerance (int, optional): The tolerance for classifying angles. Defaults to 1.

    Returns:
        tuple:
            - timestamps (list of datetime): A list of timestamps extracted from the log file.
            - data (dict): A dictionary where keys are classified angles and values are lists of average distances.
            - sonar_distance (int): The sonar distance extracted from the log file.
    """

    timestamps = []
    data = {angle: [] for angle in requested_angles}
    sonar_distances = []
    
    with open(file_path, "r") as file:
        lines = file.readlines()
    
    for i, line in enumerate(lines):
        line = line.strip()
        
        if line.startswith("Date:") and "Time:" in lines[i + 1]:
            date_str = line.split("Date:")[-1].strip()
            time_str = lines[i + 1].split("Time:")[-1].strip()
            timestamp = f"{date_str} {time_str}"
            timestamp = datetime.datetime.strptime(timestamp, "%d/%m/%Y %H:%M UTC")
            timestamps.append(timestamp)
        
        if line.startswith("Raw Measurements"):
            for j in range(i + 1, len(lines)):
                if lines[j].startswith("Angle (degrees):"):
                    angle = int(lines[j].split("Angle (degrees):")[-1].strip())
                    
                    classified_angle = classify_angle(angle, requested_angles, tolerance)
                    
                    if classified_angle is not None:
                        distances_line = lines[j + 1]
                        distances = list(map(int, distances_line.split(":")[-1].strip().split(", ")))
                        
                        valid_distances = [d for d in distances if d <= 5000]
                        
                        if valid_distances:
                            avg_distance = sum(valid_distances) / len(valid_distances)
                            data[classified_angle].append(avg_distance)

        if line.startswith("Sonar Distance (mm):"):
            sonar_distance = int(line.split(":")[-1].strip())
            if sonar_distance > 2500 or sonar_distance < 0:
                sonar_distance = None
            sonar_distances.append(sonar_distance)
                        
    return timestamps, data, sonar_distances

def plot_graphs(data_all, timestamps_all, sonar_distances):
    """
    Plots graphs of average distances over time for specified angles and sonar distances.
    It also includes a horizontal line representing the initial distance. The sonar distances
    plot is currently commented out but can be included for additional functionality.

    Args:
        data_all (dict): A dictionary where keys are angles and values are lists of average distances.
        timestamps_all (list): A list of timestamps corresponding to the distance measurements.
        sonar_distances (list): A list of sonar distance measurements.

    TODO: Include more functionality for plotting cross-sectional area, automatic requested angles, and initial distances.
    """

    plt.figure(figsize=(10, 6))
    
    '''
    for angle in [0]:
        data_for_angle = data_all[angle]
        
        while len(data_for_angle) < len(timestamps_all):
            data_for_angle.append(None)
        
        plt.plot(timestamps_all, data_for_angle, label=f"Angle {angle}Â°")
    '''

    while len(sonar_distances) < len(timestamps_all):
        sonar_distances.append(None)
    
    plt.plot(timestamps_all, sonar_distances, label="Sonar Distance", linestyle="-", color="black")
    plt.axhline(y=1722, color="red", linestyle="--", label="Initial Distance")
    
    plt.xlabel("Time (UTC)")
    plt.ylabel("Average Distance")
    plt.title("StreamScope: Average Distance vs. Time")
    plt.legend()
    plt.xticks(rotation=45)
    plt.ylim(1716, 1734)
    plt.gca().invert_yaxis()
    plt.gca().xaxis.set_major_formatter(plt.matplotlib.dates.DateFormatter('%d/%m/%Y %H:%M'))
    plt.gca().xaxis.set_major_locator(plt.matplotlib.dates.MinuteLocator(interval=30))
    plt.gca().yaxis.set_major_locator(plt.MaxNLocator(nbins=20))
    plt.tight_layout()
    plt.show()

if __name__ == "__main__":

    while True:
        print("\nStreamScope Results")
        print("1. Angles Over Time.")
        print("2. Cross-Sectional View.")
        print("3. Exit.")
        choice = input("Select an option: ")

        if choice == '1':
            data_all = {-20: [], 0: [], 20: []}
            timestamps_all = []
            sonar_distances_all = []

            log_files = [f for f in os.listdir("data") if f.endswith(".txt")]
        
            requested_angles = [-20, 0, 20] 
        
            for file_name in log_files:
                file_path = os.path.join("data", file_name)
                timestamps, data, sonar_distances = read_log_file(file_path, requested_angles)

                for angle in data:
                    data_all[angle].extend(data[angle])
                timestamps_all.extend(timestamps)
                sonar_distances_all.extend(sonar_distances)

            plot_graphs(data_all, timestamps_all, sonar_distances_all)
        elif choice == '2':
            print("This option is not yet implemented.")
        elif choice == '3':
            break






